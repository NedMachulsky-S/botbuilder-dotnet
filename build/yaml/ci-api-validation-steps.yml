# TODO: Write logs

steps:
- task: DownloadPipelineArtifact@1
  displayName: 'Download BotBuilderDLLs artifact'
  inputs:
    artifactName: 'BotBuilderDLLs-Debug-Windows-netcoreapp31'
    targetPath: '$(System.ArtifactsDirectory)/Artifacts'

- powershell: |
    $xml = "<?xml version=""1.0"" encoding=""utf-8""?>`n<packages>`n"

    $env:BotBuilderDll.Split(",") | ForEach-Object {
      $library = $_.Trim()
      $xml += "  <package id=""" + $library + """ version=""" + $env:ApiCompatVersion + """/>`n"
    }
    $xml += "</packages>"
    New-Item -Path $(System.DefaultWorkingDirectory) -Name "packages.config" -ItemType "file" -Value $xml -Force
    
    $xml
  displayName: 'Generate NuGet packages.config File'

- task: NuGetCommand@2
  displayName: 'NuGet Install Packages'
  inputs:
    command: custom
    arguments: 'install $(System.DefaultWorkingDirectory)\packages.config -OutputDirectory $(System.DefaultWorkingDirectory)\DownloadedNuGet'

- task: CmdLine@1
  displayName: 'Run dir'
  inputs:
    filename: dir
    arguments: '..\*.* /s'
  enabled: false

- powershell: |
    $libraries = ($env:BotBuilderDll -replace ",", ".dll ") + ".dll"

    Write-Host "##vso[task.setvariable variable=librariesToCompare]$libraries"

    $path = "DownloadedNuGet\**\lib\netstandard2.0\*"

    If (!(Test-Path "LibrariesToCompare\")) {
      New-Item -Path "LibrariesToCompare\" -ItemType Directory
    }

    Copy-Item -Path $path -Destination "LibrariesToCompare\" -Recurse -Force

  displayName: 'Prepare Nuget Libraries to Binary Compare'

- task: CmdLine@1
  displayName: 'NuGet LibrariesToCompare Folder'
  inputs:
    filename: dir
    arguments: 'LibrariesToCompare\*.* /s'

- task: SOUTHWORKS.binaries-comparer.custom-build-release-task.binaries-comparer@0
  displayName: 'Compare Binaries'
  inputs:
    contractsRootFolder: 'LibrariesToCompare\'
    contractsFileName: '$(librariesToCompare)'
    implFolder: '$(System.ArtifactsDirectory)/Artifacts'
    failOnIssue: true
    resolveFx: false
    generateLog: true
    outputFilename: 'CompatResults.txt'
    outputFolder: '$(Build.ArtifactStagingDirectory)'
    useBaseline: false

- powershell: |
    $FilePath = "$(Build.ArtifactStagingDirectory)\"
    $FileName = "CompatResults.txt"

    $FileFullPath = $FilePath + $FileName
    $FileContent = @(Get-Content $FileFullPath)

    $result = ''
    $failed = $FALSE;

    ForEach ($line in $FileContent) {
      if ($line.StartsWith(':x:','CurrentCultureIgnoreCase')) {
        $failed = $TRUE
        $result += ":x: Found at least one binary incompatibility:`n"
        $result += $line.Replace(":x: ", "") + "`n"
      } elseif ($failed) {
        $result += $line + "`n"
      } else {
        $firstIndex =  $line.IndexOf('**') + 2
        $lastIndex = $line.LastIndexOf('**')
        $libraries = $line.Substring($firstIndex, $lastIndex - $firstIndex).Split(' ')
        $result = $line.Substring(0, $firstIndex - 3) + ':' + "`n"
        ForEach ($library in $libraries) {
          $libraryName = $library.Replace('.dll','') 
          $libraryName += " compared against [version $ApiCompatVersion](https://www.nuget.org/packages/$libraryName/$ApiCompatVersion)"
          $result += '- ' + $libraryName + "`n"
        }
        break;
      }
    }
        
    Set-Content -Path $FileFullPath -Value $result
    $result
  displayName: 'Format CompatResults file'
  condition: succeededOrFailed()

- task: PublishBuildArtifacts@1
  displayName: 'Publish CompatResults to artifact'
  inputs:
    ArtifactName: 'BotBuilderDLLs.CompatResults'

- script: |
   cd ..
   dir /s
  displayName: 'Dir workspace'
  continueOnError: true
  condition: succeededOrFailed()
