name: $(Build.BuildId)

pool:
  name: Hosted Windows 2019 with VS2019
  demands:
  - msbuild
  - visualstudio

# No "paths exclude" here: not supported by github required status checks.
trigger: # ci trigger
  branches:
    include:
     - master

pr: # pr trigger
  branches:
    include:
     - master

variables:
  ApiCompatVersion: 4.6.3
  BotBuilderDll: Microsoft.Bot.Builder.AI.Luis,Microsoft.Bot.Builder.AI.QnA,Microsoft.Bot.Builder.ApplicationInsights,Microsoft.Bot.Builder.Azure,Microsoft.Bot.Builder.Dialogs,Microsoft.Bot.Builder.Integration.ApplicationInsights.Core,Microsoft.Bot.Builder.Integration.AspNet.Core,Microsoft.Bot.Builder.TemplateManager,Microsoft.Bot.Builder.Testing,Microsoft.Bot.Builder,Microsoft.Bot.Configuration,Microsoft.Bot.Connector,Microsoft.Bot.Schema,Microsoft.Bot.Streaming
  BuildConfiguration: Debug-Windows
  BuildPlatform: any cpu
#  DotNetCoverallsToken: define this in Azure
#  GitHubCommentApiKey: define this in Azure
  IsBuildServer: true # This activates package versioning in the projects in Microsoft.Bot.Builder.sln.
  MSBuildArguments: -p:SignAssembly=false -p:delaySign=false
  Parameters.solution: Microsoft.Bot.Builder.sln
  PreviewPackageVersion: 4.9.0-preview-$(Build.BuildNumber) # This is consumed by projects in Microsoft.Bot.Builder.sln.
  ReleasePackageVersion: 4.9.0-preview-$(Build.BuildNumber) # This is consumed by projects in Microsoft.Bot.Builder.sln.
  runCodesignValidationInjection: false # Disables unnecessary CodeSign Validation step
  NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/packages


jobs:
- job: Debug_Windows_Configuration_21
  variables:
    BuildConfiguration: Debug-Windows
    BuildTarget: 'netcoreapp21' # set the TargetFramework property for tests to use netcoreapp2.1
  steps:
  - powershell: |
     $cacheKey=$(Get-Date -Format "MM/yyyy") + "-" + "$(Agent.JobName)";
     Write-Host "##vso[task.setvariable variable=cacheKey]$cacheKey";
    displayName: 'Set date for NuGet cache variable'

  - task: Cache@2
    displayName: Cache NuGet packages
    inputs:
      key: 'nuget | "$(cacheKey)" | "$(Agent.OS)" | **/*.csproj'
      restoreKeys: |
        nuget | "$(cacheKey)" | "$(Agent.OS)"
        nuget | "$(cacheKey)"
      path: $(NUGET_PACKAGES)

  - task: NuGetCommand@2
    displayName: 'NuGet restore'
    inputs:
      restoreSolution: '$(Parameters.solution)'

- job: Debug_Windows_Configuration_31
  variables:
    BuildConfiguration: Debug-Windows
    BuildTarget: 'netcoreapp31' # set the TargetFramework property for tests to use netcoreapp3.1
  steps:
  - powershell: |
     $cacheKey=$(Get-Date -Format "MM/yyyy") + "-" + "$(Agent.JobName)";
     Write-Host "##vso[task.setvariable variable=cacheKey]$cacheKey";
    displayName: 'Set cache key for NuGet packages'

  - task: Cache@2
    displayName: Cache NuGet packages
    inputs:
      key: 'nuget | "$(cacheKey)" | "$(Agent.OS)" | **/*.csproj'
      restoreKeys: |
        nuget | "$(cacheKey)" | "$(Agent.OS)"
        nuget | "$(cacheKey)"
      path: $(NUGET_PACKAGES)

  - task: NuGetCommand@2
    displayName: 'NuGet restore'
    inputs:
      restoreSolution: '$(Parameters.solution)'

- job: Release_Windows_Configuration_21
  variables:
    BuildConfiguration: Release-Windows
    BuildTarget: 'netcoreapp21' # set the TargetFramework property for tests to use netcoreapp2.1
  steps:
  - powershell: |
     $cacheKey=$(Get-Date -Format "MM/yyyy") + "-" + "$(Agent.JobName)";
     Write-Host "##vso[task.setvariable variable=cacheKey]$cacheKey";
    displayName: 'Set cache key for NuGet packages'

  - task: Cache@2
    displayName: Cache NuGet packages
    inputs:
      key: 'nuget | "$(cacheKey)" | "$(Agent.OS)" | **/*.csproj'
      restoreKeys: |
        nuget | "$(cacheKey)" | "$(Agent.OS)"
        nuget | "$(cacheKey)"
      path: $(NUGET_PACKAGES)

  - task: NuGetCommand@2
    displayName: 'NuGet restore'
    inputs:
      restoreSolution: '$(Parameters.solution)'

- job: Release_Windows_Configuration_31
  variables:
    BuildConfiguration: Release-Windows
    BuildTarget: 'netcoreapp31' # set the TargetFramework property for tests to use netcoreapp3.1
  steps:
  - powershell: |
     $cacheKey=$(Get-Date -Format "MM/yyyy") + "-" + "$(Agent.JobName)";
     Write-Host "##vso[task.setvariable variable=cacheKey]$cacheKey";
    displayName: 'Set cache key for NuGet packages'

  - task: Cache@2
    displayName: Cache NuGet packages
    inputs:
      key: 'nuget | "$(cacheKey)" | "$(Agent.OS)" | **/*.csproj'
      restoreKeys: |
        nuget | "$(cacheKey)" | "$(Agent.OS)"
        nuget | "$(cacheKey)"
      path: $(NUGET_PACKAGES)

  - task: NuGetCommand@2
    displayName: 'NuGet restore'
    inputs:
      restoreSolution: '$(Parameters.solution)'
